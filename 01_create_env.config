option_settings:
  aws:elasticbeanstalk:application:environment:
    MAIL_SERVER: 'sandbox.smtp.mailtrap.io'
    MAIL_PORT: '587'
    MAIL_USE_TLS: 'True'
    MAIL_USE_SSL: 'False'
    MAIL_DEFAULT_SENDER: 'test@example.com'

container_commands:
  01_retrieve_secrets:
    command: |
      echo "Retrieving secrets from AWS SSM Parameter Store..."
      MAIL_USERNAME=$(aws ssm get-parameter --name "MAIL_USERNAME" --with-decryption --query "Parameter.Value" --output text)
      MAIL_PASSWORD=$(aws ssm get-parameter --name "MAIL_PASSWORD" --with-decryption --query "Parameter.Value" --output text)
      echo "MAIL_USERNAME=$MAIL_USERNAME" >> /tmp/.env
      echo "MAIL_PASSWORD=$MAIL_PASSWORD" >> /tmp/.env
      echo "MAIL_SERVER=sandbox.smtp.mailtrap.io" >> /tmp/.env
      echo "MAIL_PORT=587" >> /tmp/.env
      echo "MAIL_USE_TLS=True" >> /tmp/.env
      echo "MAIL_USE_SSL=False" >> /tmp/.env
      echo "MAIL_DEFAULT_SENDER=test@example.com" >> /tmp/.env
  02_create_secret_key:
    command: |
      if [ ! -f /tmp/secret.key ]; then
        echo "Creating secret key using generate_key.py..."
        python generate_key.py
        mv secret.key /tmp/secret.key
      fi
  03_move_files:
    command: |
      mv /tmp/.env /var/app/current/.env
      mv /tmp/secret.key /var/app/current/secret.key